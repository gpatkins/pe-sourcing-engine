{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block extra_head %}
<style>
    /* Dashboard-specific styles */
    .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #64748b;
        box-shadow: 0 0 5px rgba(100, 116, 139, 0.5);
        transition: all 0.3s ease;
    }
    .status-dot.active {
        background: #22c55e;
        box-shadow: 0 0 10px rgba(34, 197, 94, 0.8);
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.6; }
        100% { opacity: 1; }
    }

    /* Progress window styles */
    .stage-box.active {
        border-color: #4f46e5;
        background-color: #eef2ff;
    }
    .stage-box.complete {
        border-color: #22c55e;
        background-color: #f0fdf4;
    }
    .stage-box.error {
        border-color: #ef4444;
        background-color: #fef2f2;
    }
</style>
{% endblock %}

{% block content %}
<div class="py-10">
    <header class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="md:flex md:items-center md:justify-between">
            <div class="min-w-0 flex-1">
                <h1 class="text-3xl font-bold tracking-tight text-gray-900">Private Equity Sourcing Dashboard</h1>
                <p class="mt-2 text-sm text-gray-700">Automated Deal Origination Platform</p>
            </div>
            <div class="mt-4 flex md:ml-4 md:mt-0">
                <a href="{{ metabase_url }}" target="_blank"
                   class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                    üìä Open Metabase Analytics
                    <svg class="ml-2 h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.25 5.5a.75.75 0 0 0-.75.75v8.5c0 .414.336.75.75.75h8.5a.75.75 0 0 0 .75-.75v-4a.75.75 0 0 1 1.5 0v4A2.25 2.25 0 0 1 12.75 17h-8.5A2.25 2.25 0 0 1 2 14.75v-8.5A2.25 2.25 0 0 1 4.25 4h5a.75.75 0 0 1 0 1.5h-5Z" clip-rule="evenodd" />
                        <path fill-rule="evenodd" d="M6.194 12.753a.75.75 0 0 0 1.06.053L16.5 4.44v2.81a.75.75 0 0 0 1.5 0v-4.5a.75.75 0 0 0-.75-.75h-4.5a.75.75 0 0 0 0 1.5h2.553l-9.056 8.194a.75.75 0 0 0-.053 1.06Z" clip-rule="evenodd" />
                    </svg>
                </a>
            </div>
        </div>
    </header>

    <main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 mt-8">
        <!-- Status Bar -->
        <div class="bg-white shadow sm:rounded-lg mb-6">
            <div class="px-4 py-5 sm:p-6 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div id="status-dot" class="status-dot"></div>
                    <span id="status-text" class="text-sm font-medium text-gray-700">System Idle</span>
                </div>
                <button onclick="stopPipeline()"
                        class="inline-flex items-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500">
                    üõë STOP PROCESS
                </button>
            </div>
        </div>

        <!-- Stats Grid -->
        <dl class="mt-5 grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4 mb-8">
            <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
                <dt class="truncate text-sm font-medium text-gray-500">Discovered</dt>
                <dd id="stat-discovered" class="mt-1 text-3xl font-semibold tracking-tight text-gray-900">{{ stats.discovered_count }}</dd>
                <dd class="mt-1 text-xs text-gray-500">Raw targets found</dd>
            </div>
            <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
                <dt class="truncate text-sm font-medium text-gray-500">Enriched</dt>
                <dd id="stat-enriched" class="mt-1 text-3xl font-semibold tracking-tight text-gray-900">{{ stats.enriched_count }}</dd>
                <dd class="mt-1 text-xs text-gray-500">Full data collected</dd>
            </div>
            <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
                <dt class="truncate text-sm font-medium text-gray-500">Scored</dt>
                <dd id="stat-scored" class="mt-1 text-3xl font-semibold tracking-tight text-gray-900">{{ stats.scored_count }}</dd>
                <dd class="mt-1 text-xs text-gray-500">Ranked & Rated</dd>
            </div>
            <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6 ring-1 ring-red-200">
                <dt class="truncate text-sm font-medium text-red-600">Risks</dt>
                <dd id="stat-risk" class="mt-1 text-3xl font-semibold tracking-tight text-red-600">{{ stats.risk_count }}</dd>
                <dd class="mt-1 text-xs text-red-500">Active Alerts</dd>
            </div>
        </dl>

        <!-- Pipeline Controls -->
        <div class="bg-white shadow sm:rounded-lg mb-8">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-base font-semibold leading-6 text-gray-900 mb-4">Pipeline Controls</h3>
                <div class="grid grid-cols-1 gap-3 sm:grid-cols-2 lg:grid-cols-5">
                    <form method="post" action="/run/discover">
                        <button type="submit" class="w-full inline-flex justify-center items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                            1. Run Discovery
                        </button>
                    </form>
                    <form method="post" action="/run/enrich">
                        <button type="submit" class="w-full inline-flex justify-center items-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500">
                            2. Run Enrichment
                        </button>
                    </form>
                    <form method="post" action="/run/score">
                        <button type="submit" class="w-full inline-flex justify-center items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                            3. Run Scoring
                        </button>
                    </form>
                    <a href="/discovery" class="w-full inline-flex justify-center items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                        Manage Queries
                    </a>
                    {% if current_user.role == 'admin' %}
                    <button onclick="clearCompaniesDatabase()" class="w-full inline-flex justify-center items-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500">
                        üóëÔ∏è Clear Database
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Pipeline Progress -->
        <div class="bg-white shadow sm:rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-base font-semibold leading-6 text-gray-900">Pipeline Progress</h3>
                    <button onclick="downloadLogs()"
                            class="inline-flex items-center rounded-md bg-gray-600 px-3 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-gray-500">
                        üì• Download Logs
                    </button>
                </div>

                <div id="progress-container" class="space-y-4">
                    <!-- Progress Stages -->
                    <div class="grid grid-cols-3 gap-4">
                        <div id="stage-discover" class="stage-box bg-gray-50 border-2 border-gray-300 rounded-lg p-4 text-center transition-all">
                            <div class="stage-icon text-3xl mb-2">üîç</div>
                            <div class="stage-name font-semibold text-gray-700">Discovery</div>
                            <div class="stage-status text-sm text-gray-500 mt-1">Pending</div>
                        </div>
                        <div id="stage-enrich" class="stage-box bg-gray-50 border-2 border-gray-300 rounded-lg p-4 text-center transition-all">
                            <div class="stage-icon text-3xl mb-2">üìä</div>
                            <div class="stage-name font-semibold text-gray-700">Enrichment</div>
                            <div class="stage-status text-sm text-gray-500 mt-1">Pending</div>
                        </div>
                        <div id="stage-score" class="stage-box bg-gray-50 border-2 border-gray-300 rounded-lg p-4 text-center transition-all">
                            <div class="stage-icon text-3xl mb-2">‚≠ê</div>
                            <div class="stage-name font-semibold text-gray-700">Scoring</div>
                            <div class="stage-status text-sm text-gray-500 mt-1">Pending</div>
                        </div>
                    </div>

                    <!-- Status Message -->
                    <div id="progress-message" class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center text-sm text-gray-700">
                        System idle - Ready to run pipeline
                    </div>

                    <!-- Progress Bar -->
                    <div class="bg-gray-200 rounded-full h-4 overflow-hidden">
                        <div id="progress-bar" class="bg-indigo-600 h-full transition-all duration-500" style="width: 0%"></div>
                    </div>

                    <!-- Elapsed Time -->
                    <div id="progress-time" class="text-center text-sm text-gray-600">
                        Elapsed: 0s
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let progressStartTime = null;
    let progressInterval = null;

    function stopPipeline() {
        if(confirm("Are you sure you want to FORCE STOP the current process?")) {
            fetch('/api/stop', {method: 'POST'})
                .then(r => r.json())
                .then(d => alert("Stop signal sent. Process will halt shortly."));
        }
    }

    function downloadLogs() {
        window.location.href = '/api/pipeline/logs/download';
    }

    function clearCompaniesDatabase() {
        if(confirm("‚ö†Ô∏è WARNING: This will permanently delete ALL companies from the database!\n\nAre you absolutely sure?")) {
            if(confirm("This action CANNOT be undone. Delete all companies?")) {
                fetch('/admin/clear-companies', {method: 'POST'})
                    .then(r => r.json())
                    .then(data => {
                        if(data.success) {
                            alert("‚úÖ " + data.message);
                            location.reload();
                        } else {
                            alert("‚ùå Error: " + data.message);
                        }
                    })
                    .catch(err => {
                        alert("‚ùå Network error: " + err);
                    });
            }
        }
    }

    function updateDashboard() {
        fetch('/api/status')
            .then(r => r.json())
            .then(data => {
                // Update Status Bar
                const statusText = document.getElementById('status-text');
                const statusDot = document.getElementById('status-dot');

                if (data.status === 'idle') {
                    statusText.innerText = "System Idle";
                    statusText.className = "text-sm font-medium text-gray-700";
                    statusDot.className = "status-dot";
                } else {
                    statusText.innerText = "Running: " + data.status;
                    statusText.className = "text-sm font-medium text-green-600";
                    statusDot.className = "status-dot active";
                }

                // Update Stats
                document.getElementById('stat-discovered').innerText = data.stats.discovered_count;
                document.getElementById('stat-enriched').innerText = data.stats.enriched_count;
                document.getElementById('stat-scored').innerText = data.stats.scored_count;
                document.getElementById('stat-risk').innerText = data.stats.risk_count;
            })
            .catch(err => console.error("Stats poll failed", err));
    }

    function updateProgress() {
        fetch('/api/pipeline/progress')
            .then(r => r.json())
            .then(progress => {
                const stage = progress.stage;
                const status = progress.status;
                const message = progress.message;

                // Update message
                const messageBox = document.getElementById('progress-message');
                messageBox.textContent = message;

                // Reset all stages
                ['discover', 'enrich', 'score'].forEach(s => {
                    const box = document.getElementById(`stage-${s}`);
                    box.className = 'stage-box bg-gray-50 border-2 border-gray-300 rounded-lg p-4 text-center transition-all';
                    const statusEl = box.querySelector('.stage-status');
                    statusEl.textContent = 'Pending';
                    statusEl.className = 'stage-status text-sm text-gray-500 mt-1';
                });

                // Update current stage
                if (stage !== 'idle') {
                    const currentBox = document.getElementById(`stage-${stage}`);
                    const statusEl = currentBox.querySelector('.stage-status');

                    if (status === 'running') {
                        currentBox.className = 'stage-box active bg-gray-50 border-2 border-indigo-500 rounded-lg p-4 text-center transition-all';
                        statusEl.textContent = 'Running...';
                        statusEl.className = 'stage-status text-sm text-indigo-600 font-semibold mt-1';
                        messageBox.className = 'bg-blue-50 border border-blue-200 rounded-lg p-4 text-center text-sm text-gray-700';

                        // Start timer when running begins
                        if (!progressStartTime) {
                            progressStartTime = new Date();
                        }
                    } else if (status === 'complete') {
                        currentBox.className = 'stage-box complete bg-gray-50 border-2 border-green-500 rounded-lg p-4 text-center transition-all';
                        statusEl.textContent = 'Complete ‚úì';
                        statusEl.className = 'stage-status text-sm text-green-600 font-semibold mt-1';
                        messageBox.className = 'bg-green-50 border border-green-200 rounded-lg p-4 text-center text-sm text-gray-700';
                    } else if (status === 'error') {
                        currentBox.className = 'stage-box error bg-gray-50 border-2 border-red-500 rounded-lg p-4 text-center transition-all';
                        statusEl.textContent = 'Error ‚úó';
                        statusEl.className = 'stage-status text-sm text-red-600 font-semibold mt-1';
                        messageBox.className = 'bg-red-50 border border-red-200 rounded-lg p-4 text-center text-sm text-gray-700';
                    }
                } else {
                    progressStartTime = null;
                    messageBox.className = 'bg-blue-50 border border-blue-200 rounded-lg p-4 text-center text-sm text-gray-700';
                }

                // Update progress bar (simple estimation)
                const progressBar = document.getElementById('progress-bar');
                let percent = 0;
                if (stage === 'discover' && status === 'running') percent = 15;
                else if (stage === 'discover' && status === 'complete') percent = 33;
                else if (stage === 'enrich' && status === 'running') percent = 50;
                else if (stage === 'enrich' && status === 'complete') percent = 66;
                else if (stage === 'score' && status === 'running') percent = 85;
                else if (stage === 'score' && status === 'complete') percent = 100;
                progressBar.style.width = percent + '%';

                // Update elapsed time
                if (status === 'running') {
                    if (!progressStartTime) {
                        progressStartTime = new Date();
                    }
                    const now = new Date();
                    const elapsed = Math.floor((now - progressStartTime) / 1000);
                    document.getElementById('progress-time').textContent = `Elapsed: ${elapsed}s`;
                } else if (status === 'complete' || status === 'error') {
                    // Reset timer on completion
                    progressStartTime = null;
                    document.getElementById('progress-time').textContent = '';
                } else if (status === 'idle') {
                    progressStartTime = null;
                    document.getElementById('progress-time').textContent = 'Elapsed: 0s';
                    progressBar.style.width = '0%';
                }
            })
            .catch(err => console.error("Progress poll failed", err));
    }

    // Update every 2 seconds
    setInterval(updateDashboard, 2000);
    setInterval(updateProgress, 2000);
    updateDashboard();
    updateProgress();
</script>
{% endblock %}
