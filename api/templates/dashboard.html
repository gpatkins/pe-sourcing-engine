{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block extra_head %}
<style>
    /* Dashboard-specific styles */
    .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #64748b;
        box-shadow: 0 0 5px rgba(100, 116, 139, 0.5);
        transition: all 0.3s ease;
    }
    .status-dot.active {
        background: #22c55e;
        box-shadow: 0 0 10px rgba(34, 197, 94, 0.8);
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.6; }
        100% { opacity: 1; }
    }
</style>
{% endblock %}

{% block content %}
<div class="py-10">
    <header class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="md:flex md:items-center md:justify-between">
            <div class="min-w-0 flex-1">
                <h1 class="text-3xl font-bold tracking-tight text-gray-900">Private Equity Sourcing Dashboard</h1>
                <p class="mt-2 text-sm text-gray-700">Automated Deal Origination Platform</p>
            </div>
            <div class="mt-4 flex md:ml-4 md:mt-0">
                <a href="http://10.55.55.55:3000/" target="_blank" 
                   class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                    ðŸ“Š Open Metabase Analytics
                    <svg class="ml-2 h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.25 5.5a.75.75 0 0 0-.75.75v8.5c0 .414.336.75.75.75h8.5a.75.75 0 0 0 .75-.75v-4a.75.75 0 0 1 1.5 0v4A2.25 2.25 0 0 1 12.75 17h-8.5A2.25 2.25 0 0 1 2 14.75v-8.5A2.25 2.25 0 0 1 4.25 4h5a.75.75 0 0 1 0 1.5h-5Z" clip-rule="evenodd" />
                        <path fill-rule="evenodd" d="M6.194 12.753a.75.75 0 0 0 1.06.053L16.5 4.44v2.81a.75.75 0 0 0 1.5 0v-4.5a.75.75 0 0 0-.75-.75h-4.5a.75.75 0 0 0 0 1.5h2.553l-9.056 8.194a.75.75 0 0 0-.053 1.06Z" clip-rule="evenodd" />
                    </svg>
                </a>
            </div>
        </div>
    </header>
    
    <main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 mt-8">
        <!-- Status Bar -->
        <div class="bg-white shadow sm:rounded-lg mb-6">
            <div class="px-4 py-5 sm:p-6 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div id="status-dot" class="status-dot"></div>
                    <span id="status-text" class="text-sm font-medium text-gray-700">System Idle</span>
                </div>
                <button onclick="stopPipeline()" 
                        class="inline-flex items-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500">
                    ðŸ›‘ STOP PROCESS
                </button>
            </div>
        </div>

        <!-- Stats Grid -->
        <dl class="mt-5 grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4 mb-8">
            <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
                <dt class="truncate text-sm font-medium text-gray-500">Discovered</dt>
                <dd id="stat-discovered" class="mt-1 text-3xl font-semibold tracking-tight text-gray-900">{{ stats.discovered_count }}</dd>
                <dd class="mt-1 text-xs text-gray-500">Raw targets found</dd>
            </div>
            <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
                <dt class="truncate text-sm font-medium text-gray-500">Enriched</dt>
                <dd id="stat-enriched" class="mt-1 text-3xl font-semibold tracking-tight text-gray-900">{{ stats.enriched_count }}</dd>
                <dd class="mt-1 text-xs text-gray-500">Full data collected</dd>
            </div>
            <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
                <dt class="truncate text-sm font-medium text-gray-500">Scored</dt>
                <dd id="stat-scored" class="mt-1 text-3xl font-semibold tracking-tight text-gray-900">{{ stats.scored_count }}</dd>
                <dd class="mt-1 text-xs text-gray-500">Ranked & Rated</dd>
            </div>
            <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6 ring-1 ring-red-200">
                <dt class="truncate text-sm font-medium text-red-600">Risks</dt>
                <dd id="stat-risk" class="mt-1 text-3xl font-semibold tracking-tight text-red-600">{{ stats.risk_count }}</dd>
                <dd class="mt-1 text-xs text-red-500">Active Alerts</dd>
            </div>
        </dl>

        <!-- Pipeline Controls -->
        <div class="bg-white shadow sm:rounded-lg mb-8">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-base font-semibold leading-6 text-gray-900 mb-4">Pipeline Controls</h3>
                <div class="grid grid-cols-1 gap-3 sm:grid-cols-2 lg:grid-cols-4">
                    <form method="post" action="/run/discover">
                        <button type="submit" class="w-full inline-flex justify-center items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                            1. Run Discovery
                        </button>
                    </form>
                    <form method="post" action="/run/enrich">
                        <button type="submit" class="w-full inline-flex justify-center items-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500">
                            2. Run Enrichment
                        </button>
                    </form>
                    <form method="post" action="/run/score">
                        <button type="submit" class="w-full inline-flex justify-center items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                            3. Run Scoring
                        </button>
                    </form>
                    <a href="/discovery" class="w-full inline-flex justify-center items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                        Manage Queries
                    </a>
                </div>
            </div>
        </div>

        <!-- Live Logs -->
        <div class="bg-white shadow sm:rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-base font-semibold leading-6 text-gray-900 mb-4">Live Execution Logs</h3>
                <div id="terminal" class="bg-gray-900 rounded-md p-4 font-mono text-xs text-green-400 h-80 overflow-y-auto">
                    <div>Connecting to log stream...</div>
                </div>
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function stopPipeline() {
        if(confirm("Are you sure you want to FORCE STOP the current process?")) {
            fetch('/api/stop', {method: 'POST'})
                .then(r => r.json())
                .then(d => alert("Stop signal sent. Process will halt shortly."));
        }
    }

    function updateDashboard() {
        fetch('/api/status')
            .then(r => r.json())
            .then(data => {
                // Update Status Bar
                const statusText = document.getElementById('status-text');
                const statusDot = document.getElementById('status-dot');

                if (data.status === 'idle') {
                    statusText.innerText = "System Idle";
                    statusText.className = "text-sm font-medium text-gray-700";
                    statusDot.className = "status-dot";
                } else {
                    statusText.innerText = "Running: " + data.status;
                    statusText.className = "text-sm font-medium text-green-600";
                    statusDot.className = "status-dot active";
                }

                // Update Stats
                document.getElementById('stat-discovered').innerText = data.stats.discovered_count;
                document.getElementById('stat-enriched').innerText = data.stats.enriched_count;
                document.getElementById('stat-scored').innerText = data.stats.scored_count;
                document.getElementById('stat-risk').innerText = data.stats.risk_count;
            })
            .catch(err => console.error("Stats poll failed", err));
    }

    function updateLogs() {
        fetch('/api/logs/stream')
            .then(r => r.json())
            .then(data => {
                const terminal = document.getElementById('terminal');
                terminal.innerHTML = data.lines.map(line => `<div class="mb-1 border-b border-gray-800 pb-1">${escapeHtml(line)}</div>`).join('');
                terminal.scrollTop = terminal.scrollHeight;
            });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    setInterval(updateDashboard, 2000);
    setInterval(updateLogs, 2000);
    updateDashboard();
    updateLogs();
</script>
{% endblock %}
