{% extends "base.html" %}

{% block title %}Discovery Query Manager{% endblock %}

{% block content %}
<div class="py-10">
    <header class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="md:flex md:items-center md:justify-between">
            <div class="min-w-0 flex-1">
                <h1 class="text-3xl font-bold tracking-tight text-gray-900">Discovery Query Manager</h1>
                <p class="mt-2 text-sm text-gray-700">Manage the Google Places search queue</p>
            </div>
            <div class="mt-4 flex md:ml-4 md:mt-0">
                <a href="/dashboard"
                   class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                    <svg class="-ml-0.5 mr-1.5 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M11.78 5.22a.75.75 0 0 1 0 1.06L8.06 10l3.72 3.72a.75.75 0 1 1-1.06 1.06l-4.25-4.25a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" />
                    </svg>
                    Back to Dashboard
                </a>
            </div>
        </div>
    </header>

    <main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 mt-8">
        <!-- Scale Generator -->
        <div class="bg-gradient-to-r from-indigo-50 to-blue-50 border border-indigo-200 shadow sm:rounded-lg mb-6">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-base font-semibold leading-6 text-gray-900 flex items-center gap-2">
                    üöÄ Scale Generator
                </h3>
                <div class="mt-2 max-w-xl text-sm text-gray-700">
                    <p>Enter a base intent and we will generate targeted queries for all active cities below.</p>
                </div>
                <form method="post" action="/discovery-queries/generate" class="mt-5 sm:flex sm:items-center gap-3">
                    <div class="w-full sm:max-w-md">
                        <input type="text"
                               name="base_query"
                               placeholder="Enter base query (e.g. Commercial Roofing)"
                               required
                               class="block w-full bg-white rounded-md border-0 py-2 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                    </div>
                    <div class="w-full sm:max-w-xs mt-3 sm:mt-0">
                        <input type="number"
                               name="limit"
                               value="20"
                               min="1"
                               placeholder="Max results"
                               title="Max results per city"
                               class="block w-full bg-white rounded-md border-0 py-2 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                    </div>
                    <button type="submit"
                            class="mt-3 inline-flex w-full items-center justify-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 sm:mt-0 sm:w-auto">
                        <span id="generate-btn-text">Generate Queries</span>
                    </button>
                </form>
            </div>
        </div>

        <!-- Two Column Grid -->
        <div class="grid grid-cols-1 gap-6 lg:grid-cols-2 mb-6">
            <!-- Add Single Query -->
            <div class="bg-white shadow sm:rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-base font-semibold leading-6 text-gray-900">Add Single Query</h3>
                    <form method="post" action="/discovery-queries/add" class="mt-5 space-y-4">
                        <div>
                            <input type="text"
                                   name="label"
                                   placeholder="Label (optional)"
                                   class="block w-full bg-white rounded-md border-0 py-2 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                        </div>
                        <div>
                            <input type="text"
                                   name="text_query"
                                   placeholder="Query text..."
                                   required
                                   class="block w-full bg-white rounded-md border-0 py-2 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="text"
                                   name="region_code"
                                   value="US"
                                   placeholder="Region"
                                   class="block w-full bg-white rounded-md border-0 py-2 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                            <input type="number"
                                   name="limit"
                                   value="20"
                                   placeholder="Limit"
                                   min="1"
                                   class="block w-full bg-white rounded-md border-0 py-2 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                        </div>
                        <button type="submit"
                                class="w-full inline-flex justify-center items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                            Add Query
                        </button>
                    </form>
                </div>
            </div>

            <!-- Cleanup -->
            <div class="bg-white shadow sm:rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-base font-semibold leading-6 text-gray-900">Cleanup</h3>
                    <div class="mt-2 max-w-xl text-sm text-gray-500">
                        <p>Remove all queries to start fresh.</p>
                    </div>
                    <form method="post" action="/discovery-queries/delete-all" onsubmit="return confirm('Are you sure? This will delete ALL queries.');" class="mt-5">
                        <button type="submit"
                                class="w-full inline-flex justify-center items-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-red-600">
                            Delete All Queries
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Active Queries Table -->
        <div class="bg-white shadow sm:rounded-lg mb-6">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-base font-semibold leading-6 text-gray-900 mb-4">
                    Active Queries ({{ queries|length }})
                </h3>

                {% if queries %}
                <div class="flow-root">
                    <div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
                        <div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
                            <table class="min-w-full divide-y divide-gray-300">
                                <thead>
                                    <tr>
                                        <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-0">#</th>
                                        <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Label</th>
                                        <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Text Query</th>
                                        <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Limit</th>
                                        <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-0">
                                            <span class="sr-only">Delete</span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    {% for idx, q in queries %}
                                    <tr>
                                        <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-0">{{ idx + 1 }}</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">{{ q.label }}</td>
                                        <td class="px-3 py-4 text-sm text-gray-900">{{ q.text_query }}</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">{{ q.limit or 20 }}</td>
                                        <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-0">
                                            <form method="post" action="/discovery-queries/delete/{{ idx }}" class="inline">
                                                <button type="submit" class="text-red-600 hover:text-red-900">
                                                    Delete
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-12">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                    </svg>
                    <h3 class="mt-2 text-sm font-semibold text-gray-900">No queries</h3>
                    <p class="mt-1 text-sm text-gray-500">Get started by adding a query or using the Scale Generator.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Scale Generator Locations -->
        <div class="bg-white shadow sm:rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="text-base font-semibold leading-6 text-gray-900">Scale Generator Locations</h3>
                        <p class="mt-1 text-sm text-gray-500">Manage cities/states used by the Scale Generator</p>
                    </div>
                    <button onclick="showAddLocationModal()" class="inline-flex items-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500">
                        + Add Location
                    </button>
                </div>

                <div id="locations-loading" class="text-center py-8">
                    <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-indigo-600 border-r-transparent"></div>
                    <p class="mt-2 text-sm text-gray-500">Loading locations...</p>
                </div>

                <div id="locations-container" class="hidden">
                    <div class="mb-4">
                        <input type="text" id="location-search" placeholder="Search locations..." class="block w-full bg-white rounded-md border-0 py-2 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm">
                    </div>
                    <div class="flow-root">
                        <div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
                            <div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
                                <table class="min-w-full divide-y divide-gray-300">
                                    <thead>
                                        <tr>
                                            <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-0">City</th>
                                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">State</th>
                                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Status</th>
                                            <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-0">
                                                <span class="sr-only">Actions</span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="locations-tbody" class="divide-y divide-gray-200">
                                        <!-- Populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Add Location Modal -->
<div id="add-location-modal" class="hidden fixed inset-0 bg-gray-900/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Add New Location</h3>
            <form id="add-location-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">City</label>
                    <input type="text" id="new-city" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">State (2-letter code)</label>
                    <input type="text" id="new-state" required maxlength="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" style="text-transform: uppercase;">
                </div>
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 inline-flex justify-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500">
                        Add Location
                    </button>
                    <button type="button" onclick="hideAddLocationModal()" class="flex-1 inline-flex justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let allLocations = [];

// Load locations on page load
document.addEventListener('DOMContentLoaded', function() {
    loadLocations();
});

function loadLocations() {
    fetch('/api/scale-generator/locations')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                allLocations = data.locations;
                renderLocations(allLocations);
                document.getElementById('locations-loading').classList.add('hidden');
                document.getElementById('locations-container').classList.remove('hidden');
                updateGenerateButtonText();
            }
        })
        .catch(err => {
            console.error('Failed to load locations:', err);
            document.getElementById('locations-loading').innerHTML = '<p class="text-red-600">Failed to load locations</p>';
        });
}

function updateGenerateButtonText() {
    const activeCount = allLocations.filter(l => l.is_active).length;
    document.getElementById('generate-btn-text').textContent = `Generate ${activeCount} Queries`;
}

function renderLocations(locations) {
    const tbody = document.getElementById('locations-tbody');
    tbody.innerHTML = locations.map(loc => `
        <tr>
            <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-0">${loc.city}</td>
            <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${loc.state}</td>
            <td class="whitespace-nowrap px-3 py-4 text-sm">
                <span class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium ring-1 ring-inset ${loc.is_active ? 'bg-green-50 text-green-700 ring-green-600/20' : 'bg-gray-50 text-gray-600 ring-gray-500/10'}">
                    ${loc.is_active ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-0">
                <button onclick="toggleLocation(${loc.id}, ${!loc.is_active})" class="text-indigo-600 hover:text-indigo-900 mr-4">
                    ${loc.is_active ? 'Disable' : 'Enable'}
                </button>
                <button onclick="deleteLocation(${loc.id})" class="text-red-600 hover:text-red-900">
                    Delete
                </button>
            </td>
        </tr>
    `).join('');
}

// Search functionality
document.getElementById('location-search').addEventListener('input', function(e) {
    const search = e.target.value.toLowerCase();
    const filtered = allLocations.filter(loc =>
        loc.city.toLowerCase().includes(search) ||
        loc.state.toLowerCase().includes(search)
    );
    renderLocations(filtered);
});

function showAddLocationModal() {
    document.getElementById('add-location-modal').classList.remove('hidden');
}

function hideAddLocationModal() {
    document.getElementById('add-location-modal').classList.add('hidden');
    document.getElementById('add-location-form').reset();
}

document.getElementById('add-location-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const city = document.getElementById('new-city').value.trim();
    const state = document.getElementById('new-state').value.trim().toUpperCase();

    // Validate state is 2 letters
    if (state.length !== 2) {
        alert('‚ùå State must be exactly 2 letters');
        return;
    }

    fetch('/api/scale-generator/locations', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({city, state})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            hideAddLocationModal();
            loadLocations();
            alert('‚úÖ Location added successfully');
        } else {
            alert('‚ùå ' + data.message);
        }
    })
    .catch(err => alert('‚ùå Network error'));
});

function toggleLocation(id, isActive) {
    fetch(`/api/scale-generator/locations/${id}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({is_active: isActive})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadLocations();
        } else {
            alert('‚ùå ' + data.message);
        }
    });
}

function deleteLocation(id) {
    if (confirm('Are you sure you want to delete this location?')) {
        fetch(`/api/scale-generator/locations/${id}`, {
            method: 'DELETE'
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                loadLocations();
                alert('‚úÖ Location deleted');
            } else {
                alert('‚ùå ' + data.message);
            }
        });
    }
}
</script>
{% endblock %}
