{% extends "base.html" %}

{% block title %}API Keys Management{% endblock %}

{% block content %}
<div class="py-10">
    <header class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="md:flex md:items-center md:justify-between">
            <div class="min-w-0 flex-1">
                <h1 class="text-3xl font-bold tracking-tight text-gray-900">API Keys Management</h1>
                <p class="mt-2 text-sm text-gray-700">Manage API credentials used by the sourcing engine</p>
            </div>
        </div>
    </header>
    
    <main class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8 mt-8">
        <!-- Security Notice -->
        <div class="rounded-md bg-yellow-50 border border-yellow-200 p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495ZM10 5a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 10 5Zm0 9a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-yellow-800">Security Notice</h3>
                    <div class="mt-2 text-sm text-yellow-700">
                        <p>These API keys are used by all users for discovery and enrichment. Keep them secure and rotate regularly.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Keys List -->
        <div class="space-y-6">
            {% for credential in credentials %}
            <div class="bg-white shadow sm:rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <div class="sm:flex sm:items-start sm:justify-between">
                        <div class="flex-1">
                            <h3 class="text-base font-semibold leading-6 text-gray-900 flex items-center">
                                {{ credential.service_name|replace('_', ' ')|title }}
                                <span class="ml-2 inline-flex items-center rounded-md {% if credential.is_active %}bg-green-50 text-green-700 ring-green-600/20{% else %}bg-gray-50 text-gray-600 ring-gray-500/10{% endif %} px-2 py-1 text-xs font-medium ring-1 ring-inset">
                                    {% if credential.is_active %}Active{% else %}Inactive{% endif %}
                                </span>
                            </h3>
                            <div class="mt-2 max-w-xl text-sm text-gray-500">
                                <p>
                                    {% if credential.service_name == 'google_places' %}
                                    Used for discovering companies via Google Maps/Places API
                                    {% elif credential.service_name == 'google_gemini' %}
                                    Used for AI-powered industry classification and owner detection
                                    {% elif credential.service_name == 'serper' %}
                                    Used for news and risk analysis via Serper.dev
                                    {% else %}
                                    API credential for {{ credential.service_name }}
                                    {% endif %}
                                </p>
                                <p class="mt-1 text-xs">
                                    Last updated: {{ credential.updated_at.strftime('%B %d, %Y at %I:%M %p') if credential.updated_at else 'Never' }}
                                </p>
                            </div>
                            
                            <!-- Current Key (Masked) -->
                            <div class="mt-4" x-data="{ showKey: false }">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Current Key</label>
                                <div class="flex items-center gap-2">
                                    <code class="flex-1 bg-gray-50 px-3 py-2 rounded border border-gray-300 text-sm font-mono" x-text="showKey ? '{{ credential.api_key }}' : '{{ credential.masked_key }}'"></code>
                                    <button @click="showKey = !showKey" 
                                            type="button"
                                            class="inline-flex items-center rounded-md bg-white px-2.5 py-1.5 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                                        <svg x-show="!showKey" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path d="M10 12.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z" />
                                            <path fill-rule="evenodd" d="M.664 10.59a1.651 1.651 0 0 1 0-1.186A10.004 10.004 0 0 1 10 3c4.257 0 7.893 2.66 9.336 6.41.147.381.146.804 0 1.186A10.004 10.004 0 0 1 10 17c-4.257 0-7.893-2.66-9.336-6.41ZM14 10a4 4 0 1 1-8 0 4 4 0 0 1 8 0Z" clip-rule="evenodd" />
                                        </svg>
                                        <svg x-show="showKey" x-cloak class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M3.28 2.22a.75.75 0 0 0-1.06 1.06l14.5 14.5a.75.75 0 1 0 1.06-1.06l-1.745-1.745a10.029 10.029 0 0 0 3.3-4.38 1.651 1.651 0 0 0 0-1.185A10.004 10.004 0 0 0 9.999 3a9.956 9.956 0 0 0-4.744 1.194L3.28 2.22ZM7.752 6.69l1.092 1.092a2.5 2.5 0 0 1 3.374 3.373l1.091 1.092a4 4 0 0 0-5.557-5.557Z" clip-rule="evenodd" />
                                            <path d="m10.748 13.93 2.523 2.523a9.987 9.987 0 0 1-3.27.547c-4.258 0-7.894-2.66-9.337-6.41a1.651 1.651 0 0 1 0-1.186A10.007 10.007 0 0 1 2.839 6.02L6.07 9.252a4 4 0 0 0 4.678 4.678Z" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Update Form -->
                    <form action="/admin/api-keys/update/{{ credential.id }}" method="POST" class="mt-5 space-y-4">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        
                        <div>
                            <label for="api_key_{{ credential.id }}" class="block text-sm font-medium leading-6 text-gray-900">
                                New API Key
                            </label>
                            <div class="mt-2">
                                <input type="text" 
                                       name="api_key" 
                                       id="api_key_{{ credential.id }}" 
                                       class="block w-full rounded-md border-0 py-2 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"
                                       placeholder="Enter new API key...">
                            </div>
                        </div>

                        <div class="flex items-center gap-3">
                            <button type="submit" 
                                    class="inline-flex items-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
                                <svg class="-ml-0.5 mr-1.5 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" />
                                </svg>
                                Update Key
                            </button>
                            
                            <form action="/admin/api-keys/toggle/{{ credential.id }}" method="POST" class="inline">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                <button type="submit" 
                                        class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                                    {% if credential.is_active %}Disable{% else %}Enable{% endif %}
                                </button>
                            </form>
                        </div>
                    </form>
                </div>
            </div>
            {% endfor %}

            {% if not credentials %}
            <div class="bg-white shadow sm:rounded-lg">
                <div class="px-4 py-5 sm:p-6 text-center text-gray-500">
                    No API credentials configured yet.
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Documentation Links -->
        <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
            <h3 class="text-sm font-semibold text-blue-900 mb-3">Getting API Keys</h3>
            <ul class="space-y-2 text-sm text-blue-700">
                <li class="flex items-start">
                    <svg class="h-5 w-5 text-blue-500 mr-2 mt-0.5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.857-9.809a.75.75 0 0 0-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 1 0-1.06 1.061l2.5 2.5a.75.75 0 0 0 1.137-.089l4-5.5Z" clip-rule="evenodd" />
                    </svg>
                    <div>
                        <strong>Google Places API:</strong> 
                        <a href="https://console.cloud.google.com/apis/library/places-backend.googleapis.com" target="_blank" class="underline">
                            Google Cloud Console
                        </a>
                    </div>
                </li>
                <li class="flex items-start">
                    <svg class="h-5 w-5 text-blue-500 mr-2 mt-0.5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.857-9.809a.75.75 0 0 0-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 1 0-1.06 1.061l2.5 2.5a.75.75 0 0 0 1.137-.089l4-5.5Z" clip-rule="evenodd" />
                    </svg>
                    <div>
                        <strong>Google Gemini API:</strong> 
                        <a href="https://makersuite.google.com/app/apikey" target="_blank" class="underline">
                            Google AI Studio
                        </a>
                    </div>
                </li>
                <li class="flex items-start">
                    <svg class="h-5 w-5 text-blue-500 mr-2 mt-0.5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.857-9.809a.75.75 0 0 0-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 1 0-1.06 1.061l2.5 2.5a.75.75 0 0 0 1.137-.089l4-5.5Z" clip-rule="evenodd" />
                    </svg>
                    <div>
                        <strong>Serper API:</strong> 
                        <a href="https://serper.dev/api-key" target="_blank" class="underline">
                            Serper.dev Dashboard
                        </a>
                    </div>
                </li>
            </ul>
        </div>
    </main>
</div>
{% endblock %}
